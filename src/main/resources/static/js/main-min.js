var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991},"es6","es3");$jscomp.polyfill("Number.MIN_SAFE_INTEGER",function(){return-9007199254740991},"es6","es3");$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,c,d){var b=this.length||0;0>c&&(c=Math.max(0,b+c));if(null==d||d>b)d=b;d=Number(d);0>d&&(d=Math.max(0,b+d));for(c=Number(c||0);c<d;c++)this[c]=a;return this}},"es6","es3");
$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};
$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.assign="function"==typeof Object.assign?Object.assign:function(a,b){for(var c=1;c<arguments.length;c++){var d=arguments[c];if(d)for(var e in d)$jscomp.owns(d,e)&&(a[e]=d[e])}return a};$jscomp.polyfill("Object.assign",function(a){return a||$jscomp.assign},"es6","es3");$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(a){return a instanceof e?a:new e(function(b,c){b(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})}this.batch_.push(a)};var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){d(a,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];a[b]=null;try{c()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(k){b.reject(k)}};e.prototype.createResolveAndReject_=function(){function a(a){return function(d){c||(c=!0,a.call(b,d))}}var b=this,c=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(k){this.reject_(k);return}"function"==typeof b?
this.settleSameAsThenable_(b,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)f.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};e.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(l){c.reject(l)}};e.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(m){g(m)}}:b}var d,g,f=new e(function(a,b){d=a;g=b});this.callWhenSettled_(c(a,d),c(b,g));return f};
e.prototype.catch=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,b){function c(){switch(d.state_){case 1:a(d.result_);break;case 2:b(d.result_);break;default:throw Error("Unexpected state: "+d.state_);}}var d=this;null==this.onSettledCallbacks_?f.asyncExecute(c):this.onSettledCallbacks_.push(c)};e.resolve=c;e.reject=function(a){return new e(function(b,c){c(a)})};e.race=function(a){return new e(function(b,d){for(var e=$jscomp.makeIterator(a),f=e.next();!f.done;f=e.next())c(f.value).callWhenSettled_(b,
d)})};e.all=function(a){var b=$jscomp.makeIterator(a),d=b.next();return d.done?c([]):new e(function(a,e){function f(b){return function(c){g[b]=c;h--;0==h&&a(g)}}var g=[],h=0;do g.push(void 0),h++,c(d.value).callWhenSettled_(f(g.length-1),e),d=b.next();while(!d.done)})};return e},"es6","es3");var Matter=function(a,b,c){this.x=a;this.y=b;this.z=void 0===c?0:c;this.dy=this.h=this.w=0;this.dir=null;this.gravity=this.radian=0;this.speed=1};
$jscomp.global.Object.defineProperties(Matter.prototype,{width:{configurable:!0,enumerable:!0,get:function(){return this.w},set:function(a){this.w=a;this.hW=a/2}},height:{configurable:!0,enumerable:!0,get:function(){return this.h},set:function(a){this.h=a;this.hH=a/2}}});
var Actor=function(a,b,c){Matter.call(this,a,b,void 0===c?0:c);var d=this;this.region=new Region(this);this.height=this.width=16;this.animList=[];this.chamberList=[];this.hasBounds=!0;this.reaction=0;this.effectV=this.effectH=!0;this.hitPoint=1;this.absorbed=!1;this.score=0;this.walled=!1;this.recalculation();this.img=new Image;this.img.addEventListener("load",function(){d.width=d.img.width;d.height=d.img.height;d.recalculation()});this.fillStyle=null;this.sfx="sfx-explosion";this.sfxAbsorb="sfx-absorb";
this.enter()};$jscomp.inherits(Actor,Matter);Actor.prototype.recalculation=function(){var a=Field.Instance;if(a){var b=this.hasBounds?0:a.width;this.minX=-this.width-b;this.minY=-this.height-b;this.maxX=a.width+this.width+b;this.maxY=a.height+this.height+b}};Actor.prototype.enter=function(){this.explosion=0;this.isGone=!1};Actor.prototype.eject=function(){this.isGone=!0;this.x=Number.MIN_SAFE_INTEGER};
Actor.prototype.aim=function(a){if(a){var b=this.calcDistance(a);this.speed<b&&(this.dir=Math.atan2(a.y-this.y,a.x-this.x))}else this.dir=null;return this};Actor.prototype.closeGap=function(a){a=Math.trim(this.radian-Math.atan2(a.y-this.y,a.x-this.x));return Math.abs(a)<=Actor.DEG_STEP?0:0<a?-Actor.DEG_STEP:Actor.DEG_STEP};Actor.prototype.reactX=function(a){this.dir=Math.trim(this.dir+Math.PI)};Actor.prototype.reactY=function(a){this.y=a;this.dy*=-this.reaction;this.radian=0};
Actor.prototype.trigger=function(a,b){var c=this;b=void 0===b?!1:b;var d=[];this.chamberList.forEach(function(a){return a.probe()});if(this.triggered||b)this.triggered=!1,this.chamberList.forEach(function(b){(b=b.fire(c,a))&&d.push(b)});return d};
Actor.prototype.move=function(a){var b=this;if(0<this.explosion&&(this.explosion--,0==this.explosion)){this.eject();return}this.svX=this.x;this.svY=this.y;null!=this.dir&&(this.x+=Math.cos(this.dir)*this.speed,this.y+=Math.sin(this.dir)*this.speed);if(0!=this.gravity){var c=0,d=!1;0>this.gravity?(c+=this.hH,c<this.y?this.dy+=this.gravity:this.y<c&&(d=!0)):(c-=this.hH,this.y<c?this.dy+=this.gravity:c<this.y&&(d=!0));d&&this.reactY(c)}this.y+=this.dy*this.speed;this.animList.forEach(function(a){a.next(b.dir)});
return this.trigger(a)};Actor.prototype.drawCircle=function(a){a.save();a.beginPath();a.fillStyle=this.fillStyle;a.arc(0,0,this.width,0,2*Math.PI,!1);a.fill();a.restore()};Actor.prototype.drawHitPoint=function(a){1E5>this.hitPoint&&(a.save(),a.fillStyle="white",a.fillText(this.hitPoint,0,20),a.restore())};Actor.prototype.drawNormal=function(a){this.animList.forEach(function(b){b.draw(a)});0==this.animList.length&&this.fillStyle&&this.drawCircle(a)};
Actor.prototype.drawExplosion=function(a){var b=this.explosion;a.save();a.fillStyle="rgba(255, 0, 0, 0.7)";a.beginPath();a.arc(0,0,b,0,Math.PI2,!1);a.fill();a.restore()};Actor.prototype.draw=function(a){this.isGone||(a.save(),a.translate(this.x,this.y),0<this.explosion?this.drawExplosion(a):this.drawNormal(a),a.restore())};Actor.prototype.isHit=function(a){return this.isGone||0<this.explosion||0<a.explosion?!1:this.region.isHit(a.region)?(this.fate(a),a.fate(this),!0):!1};
Actor.prototype.calcDistance=function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)};Actor.prototype.fate=function(a){this.isGone||this.explosion||(this.hitPoint--,0<this.hitPoint?this.absorb(a):(this.explosion=Actor.MAX_EXPLOSION,Field.Instance.calcPan(this.x)))};
Actor.prototype.absorb=function(a){this.absorbed=!0;if(this.sfxAbsorb){var b=Field.Instance.ctx;b.fillStyle="rgba(255, 200, 0, 0.4)";b.save();b.translate(a.x,a.y);b.beginPath();b.arc(0,0,5,0,Math.PI2,!1);b.fill();b.restore();Field.Instance.calcPan(this.x)}};$jscomp.global.Object.defineProperties(Actor.prototype,{anim:{configurable:!0,enumerable:!0,set:function(a){Array.isArray(a)?this.animList=a:this.animList=[a]}}});Actor.MAX_EXPLOSION=12;Actor.DEG_STEP=Math.PI/180;
var Animator=function(a,b,c,d,e){c=void 0===c?Animator.TYPE.ROTATION:c;this.actor=a;this.type=c;this.numX=void 0===d?1:d;this.numY=void 0===e?1:e;this.patNum=0;this.loadImage(a,b)};
Animator.prototype.loadImage=function(a,b){var c=this;(this.img=ImageManager.Instance.dic[b])?(this.width=this.img.width/this.numX,this.height=this.img.height/this.numY,this.hW=this.width/2,this.hH=this.height/2,a.width=this.width,a.height=this.height,a.recalculation()):(ImageManager.Instance.reserve([b]),this.img=new Image,this.img.onload=function(){c.width=c.img.width/c.numX;c.height=c.img.height/c.numY;c.hW=c.width/2;c.hH=c.height/2;a.width=c.width;a.height=c.height;a.recalculation()},this.img.src=
"img/"+b)};
Animator.prototype.next=function(a){this.type&(Animator.TYPE.H|Animator.TYPE.V)&&.1<Math.abs(this.patNum)&&(this.patNum=0>this.patNum?this.patNum+.1:this.patNum-.1);if(null!=a)if(this.type&Animator.TYPE.X)this.patNum+=.5*Math.cos(a),a=Math.floor(this.patNum),0>a?this.patNum=this.numX-.1:this.numX<=a&&(this.patNum=0);else if(this.type&Animator.TYPE.Y)this.patNum+=.5*Math.sin(a),a=Math.floor(this.patNum),0>a?this.patNum=this.numY-.1:this.numY<=a&&(this.patNum=0);else if(this.type&Animator.TYPE.V){var b=Math.floor(this.numY/
2);this.patNum+=Math.sin(a)/3;this.patNum<-b?this.patNum=-b:b<this.patNum&&(this.patNum=b)}else this.type&Animator.TYPE.H&&(b=Math.floor(this.numX/2),this.patNum+=Math.cos(a)/3,this.patNum<-b?this.patNum=-b:b<this.patNum&&(this.patNum=b));this.patNum*=1E3;this.patNum=Math.round(this.patNum)/1E3};
Animator.prototype.draw=function(a){var b=this.actor,c=this.width,d=this.height,e=0,f=0;this.type&Animator.TYPE.X?e=c*Math.floor(this.patNum):this.type&Animator.TYPE.Y?f=d*Math.floor(this.patNum):this.type&Animator.TYPE.V?f=d*(parseInt(this.patNum)+(this.numY?parseInt(this.numY/2):0)):this.type&Animator.TYPE.H&&(e=c*(parseInt(this.patNum)+(this.numX?parseInt(this.numX/2):0)));a.save();this.type==Animator.TYPE.NONE&&b.isInverse&&a.rotate(Math.PI);this.type&Animator.TYPE.ROTATION&&a.rotate(b.radian);
b.scale&&a.scale(b.scale,b.scale);a.drawImage(this.img,e,f,c,d,-this.hW,-this.hH,c,d);a.restore()};Animator.TYPE={NONE:0,ROTATION:1,X:2,Y:4,XY:6,H:8,V:16};var Bullet=function(a,b){Actor.call(this,a,b);this.region=new Region(this,2);this.speed=2;this.width=4;this.fillStyle="rgba(120, 200, 255, 0.7)";this.recalculation()};$jscomp.inherits(Bullet,Actor);Bullet.DEG_STEP=Actor.DEG_STEP;Bullet.MAX_EXPLOSION=Actor.MAX_EXPLOSION;
Bullet.prototype.move=function(a){Actor.prototype.move.call(this,a);this.walled&&this.eject()};var Chamber=function(a,b,c,d){c=void 0===c?Number.MAX_SAFE_INTEGER:c;d=void 0===d?{}:d;this.type=a;this.cycle=b;this.max=c;this.opt=d;this.reset()};Chamber.prototype.reset=function(){this.tick=0;this.hands=[]};Chamber.prototype.probe=function(){var a=[];this.hands.forEach(function(b){b.isGone||a.push(b)});this.hands=a;this.tick++};
Chamber.prototype.fire=function(a,b){b=void 0===b?null:b;if(this.tick<this.cycle||this.max<=this.hands.length)return null;var c=new this.type(a.x,a.y,this.opt);if(b){var d=a.calcDistance(b),e=Field.Instance.stage.getFg();c.dir=Math.atan2(b.y-a.y,b.x-a.x+d/c.speed*e.speed)}this.tick=0;this.hands.push(c);return c};var Controller=function(a){this.init(void 0===a?!1:a);Controller.Instance=this};
Controller.prototype.init=function(a){var b=this;this.mouseMoving=this._contextmenu=!1;a||document.getElementById("canvas").addEventListener("contextmenu",function(a){b.mouseMoving||(b._contextmenu=!0);a.preventDefault()});this.initKeys();this.initPointingDevice()};
Controller.prototype.initKeys=function(){var a=this;this.keys={};window.addEventListener("keydown",function(b){b.key?a.keys[b.key]=!0:a.keys["k"+b.keyCode]=!0});window.addEventListener("keyup",function(b){b.key?delete a.keys[b.key]:delete a.keys["k"+b.keyCode]})};
Controller.prototype.initPointingDevice=function(){var a=this,b=document.getElementById("canvas"),c=!1,d=function(){a.point=[];a.prev=[];a.move=[];c=!1};d();b.addEventListener("mousedown",function(b){a.point=[FlexibleView.Instance.convert(b.clientX,b.clientY)];a.prev=a.point;a.move=a.point});b.addEventListener("mousemove",function(b){b=[FlexibleView.Instance.convert(b.clientX,b.clientY)];a.move=b;0<a.prev.length&&(a.point=b);c=!1});b.addEventListener("mouseup",function(){return d()});b.addEventListener("mouseleave",
function(){return d()});b.addEventListener("touchstart",function(b){Array.prototype.forEach.call(b.touches,function(b){a.point.push(FlexibleView.Instance.convert(b.pageX,b.pageY))});a.prev=a.point;a.move=a.point;c=!0;setTimeout(function(){c&&(a._contextmenu=!0)},2E3);b.preventDefault()});b.addEventListener("touchmove",function(b){var d=[];Array.prototype.forEach.call(b.touches,function(a){d.push(FlexibleView.Instance.convert(a.pageX,a.pageY))});a.move=d;0<a.prev.length&&(a.point=d);c=!1});b.addEventListener("touchend",
function(){return d()})};$jscomp.global.Object.defineProperties(Controller.prototype,{delta:{configurable:!0,enumerable:!0,get:function(){var a=this,b=[];this.mouseMoving=!1;this.point.forEach(function(c,d){var e=c.x-a.prev[d].x,f=c.y-a.prev[d].y;b.push({x:e,y:f});a.prev[d]=c;if(0!=e||0!=f)a.mouseMoving=!0});return b}},contextmenu:{configurable:!0,enumerable:!0,get:function(){var a=this._contextmenu;this._contextmenu=!1;return a}}});
var Enemy=function(a,b,c){Actor.call(this,a,b,void 0===c?0:c);this.radian=Math.PI;this.routine=null;this.routineCnt=this.routineIx=0;this.chamberList=[new Chamber(Bullet,Enemy.TRIGGER_CYCLE)]};$jscomp.inherits(Enemy,Actor);Enemy.DEG_STEP=Actor.DEG_STEP;Enemy.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Enemy.prototype.move=function(a){this.routine&&this.routine[this.routineIx].tick(this,a);var b=Actor.prototype.move.call(this,a);!(a instanceof Enemy)&&this.calcDistance(a)<Enemy.TRIGGER_ALLOWANCE&&(b=[]);return b};
Enemy.TRIGGER_CYCLE=50;Enemy.TRIGGER_ALLOWANCE=100;Enemy.MAX_TYPE=127;Enemy.LIST=[];Enemy.assign=function(a,b,c){a=Object.assign({},Enemy.LIST[a%Enemy.LIST.length]);a.x=b;a.y=c;return a};var Chain=function(a,b){Enemy.call(this,a,b);this.next=this.prev=null};$jscomp.inherits(Chain,Enemy);Chain.DEG_STEP=Enemy.DEG_STEP;Chain.MAX_EXPLOSION=Enemy.MAX_EXPLOSION;Chain.assign=Enemy.assign;Chain.LIST=Enemy.LIST;Chain.MAX_TYPE=Enemy.MAX_TYPE;Chain.TRIGGER_ALLOWANCE=Enemy.TRIGGER_ALLOWANCE;
Chain.TRIGGER_CYCLE=Enemy.TRIGGER_CYCLE;Chain.prototype.unshift=function(a){a.next=this;if(a.prev=this.prev)this.prev.next=a;this.prev=a;return this};Chain.prototype.push=function(a){a.prev=this;if(a.next=this.next)this.next.prev=a;this.next=a;return this};Chain.prototype.remove=function(){this.prev.next=this.next;this.next.prev=this.prev;return this.next};
var Field=function(a,b){Matter.call(this,0,0);this.width=a;this.height=b;this.ship=new Ship(-100,100);this.ship.isGone=!0;this.shipRemain=0;this.actorList=[];this.enemyCycle=this.hiscore=this.score=0;this.setup();Field.Instance=this};$jscomp.inherits(Field,Matter);Field.prototype.setup=function(){var a=document.getElementById("canvas");a.width=this.width;a.height=this.height;this.ctx=a.getContext("2d");this.resize()};
Field.prototype.resize=function(){var a=document.body.clientWidth/this.width,b=window.innerHeight/this.height,c=document.getElementById("view");this.scale=b<a?b:a;c.setAttribute("style","transform: scale("+this.scale+");")};Field.prototype._reset=function(){this.phase=Field.PHASE.NORMAL;this.ship.reset();this.ship.x=100;this.ship.y=100;this.ship.enter();this.actorList=[this.ship];this.hibernate=Field.MAX_HIBERNATE};Field.prototype.reset=function(){this._reset()};Field.prototype.retry=function(){this._reset()};
Field.prototype.startGame=function(){this.loosingRate=Field.MAX_LOOSING_RATE;this.score=0;this.shipRemain=Field.MAX_SHIP;this._reset()};Field.prototype.endGame=function(){};Field.prototype.isGameOver=function(){return!1};Field.prototype.calcPan=function(a){return(a-this.hW)/this.hW};Field.prototype.move=function(){this.phase!=Field.PHASE.BOSS&&!this.isGameOver()&&Field.MIN_LOOSING_RATE<this.loosingRate&&(this.loosingRate-=this.loosingRate/1E4)};
Field.prototype.draw=function(){var a=this,b=this.ctx,c=this.ship,d=[],e=[],f=[],h=0;b.save();b.clearRect(0,0,this.width,this.height);this.actorList.sort(function(a,b){return a.z-b.z});this.actorList.forEach(function(g){if(!g.isGone){g instanceof Bullet?g.isHit(c):g instanceof Enemy?(g.triggered=0==parseInt(Math.random()*a.loosingRate/10),g.isHit(c),e.push(g)):(g instanceof Shot||g instanceof Missile)&&d.push(g);var k=g.move(c);k instanceof Array&&k.forEach(function(a){f.push(a)});g.draw(b);f.push(g);
g.explosion&&g.score&&(h+=g.score,g.score=0)}});d.forEach(function(a){e.forEach(function(b){return b.isHit(a)})});this.phase==Field.PHASE.BOSS&&0==e.length&&(this.phase=Field.PHASE.NORMAL);this.actorList=f;this.score+=h;this.showScore();if(!this.isGameOver()&&c.isGone){if(0<--this.hibernate)return;0<--this.shipRemain?this.retry():this.endGame()}b.restore()};
Field.prototype.showScore=function(){this.hiscore<this.score&&(this.hiscore=this.score);var a=document.querySelector("#score > div > div:nth-child(2)"),b=document.querySelector("#score > div:nth-child(2) > div:nth-child(2)");document.querySelector("#score > div:nth-child(3)");var c=document.querySelector("#remain > div > div:nth-child(1)");a&&(a.innerHTML=this.score,b.innerHTML=this.hiscore,this.shipRemain&&(c.style.width=16*(this.shipRemain-1)+"px"))};Field.MAX_ENEMIES=100;Field.ENEMY_CYCLE=10;
Field.MIN_LOOSING_RATE=1;Field.MAX_LOOSING_RATE=2E4;Field.MAX_SHIP=7;Field.MAX_HIBERNATE=5*Actor.MAX_EXPLOSION;Field.PHASE={NORMAL:0,BOSS:1};var FlexibleView=function(a,b){this.view=document.getElementById("view");this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d");this.scale=1;this.init();this.setSize(a,b);FlexibleView.Instance=this};FlexibleView.prototype.setSize=function(a,b){this.width=a;this.height=b;this.canvas.width=a;this.canvas.height=b;this.resize()};
FlexibleView.prototype.init=function(){var a=this,b=document.querySelector('[data-role="header"]'),c=document.querySelector('[data-role="footer"]');this.headerHeight=b?b.offsetHeight:0;this.footerHeight=c?c.offsetHeight:0;this.margin=this.headerHeight+this.footerHeight;window.addEventListener("resize",function(){a.resize()});window.addEventListener("keydown",function(){a.view.classList.contains("addicting")||a.view.classList.add("addicting")});window.addEventListener("mousemove",function(){a.view.classList.remove("addicting")})};
FlexibleView.prototype.resize=function(){var a=document.body.clientWidth/this.width,b=(window.innerHeight-this.margin)/this.height;this.scale=b<a?b:a;this.view.setAttribute("style",["width:"+this.width+"px","height:"+this.height+"px","transform: scale("+this.scale+")"].join(";"))};FlexibleView.prototype.convert=function(a,b){return{x:a/this.scale,y:(b-this.headerHeight)/this.scale}};FlexibleView.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)};
var ImageManager=function(){this.loaded=this.max=0;this.dic={}};ImageManager.prototype.isComplete=function(){return 0<this.max&&this.max==this.loaded};ImageManager.prototype.reserve=function(a){var b=this;a.forEach(function(a){if(!(a in b.dic)){var c=new Image;c.onload=function(){b.dic[a]=c;b.loaded++};c.src="img/"+a;b.max++}})};ImageManager.Instance=new ImageManager;Math.PI2=Math.PI2||2*Math.PI;Math.SQ=Math.SQ||Math.PI/2;
Math.trim=Math.trim||function(a){for(;Math.PI<a;)a-=Math.PI2;for(;a<-Math.PI;)a+=Math.PI2;return a};Math.close=Math.close||function(a,b,c){b=Math.trim(a-b);return Math.abs(b)<=c?a:0<b?a-c:a+c};function Matrix(a){this.mat=a}Matrix.NO_EFFECT=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];Matrix.rotateX=function(a){return new Matrix([[1,0,0,0],[0,Math.cos(a),-Math.sin(a),0],[0,Math.sin(a),Math.cos(a),0],[0,0,0,1]])};
Matrix.rotateY=function(a){return new Matrix([[Math.cos(a),0,Math.sin(a),0],[0,1,0,0],[-Math.sin(a),0,Math.cos(a),0],[0,0,0,1]])};Matrix.rotateZ=function(a){return new Matrix([[Math.cos(a),-Math.sin(a),0,0],[Math.sin(a),Math.cos(a),0,0],[0,0,1,0],[0,0,0,1]])};Matrix.prototype.multiply=function(a){var b=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],c=a.mat;this.mat.forEach(function(a,e){a.forEach(function(d,h){for(var f=d=0;4>f;f++)d+=a[f]*c[f][h];b[e][h]=d})});return new Matrix(b)};
Matrix.prototype.affine=function(a,b,c){var d=this.mat;return{x:d[0][0]*a+d[0][1]*b+d[0][2]*c+d[0][3],y:d[1][0]*a+d[1][1]*b+d[1][2]*c+d[1][3],z:d[2][0]*a+d[2][1]*b+d[2][2]*c+d[2][3]}};var Missile=function(a,b,c){Actor.call(this,a,b);this.dir=c.dir;this.speed=3;this.width=2.5;this.gravity=c.gravity;this.recalculation();this.shuttle=3;this.fillStyle="rgba(200, 200, 255, 0.6)"};$jscomp.inherits(Missile,Actor);Missile.DEG_STEP=Actor.DEG_STEP;Missile.MAX_EXPLOSION=Actor.MAX_EXPLOSION;
Missile.prototype.reactX=function(a){Actor.prototype.reactX.call(this,a);this.shuttle--;0>this.shuttle&&this.fate()};Missile.prototype.fate=function(){this.eject()};function Gizmo(a,b,c){this.type=a;this.destination=b;this.param=void 0===c?null:c}Gizmo.TYPE={FIXED:0,OWN:1,AIM:2,CHASE:3};Gizmo.DEST={TO:0,TO_X:1,TO_Y:2,ROTATE:3,ROTATE_L:4,ROTATE_R:5,LEFT:6,RIGHT:7};
Gizmo.prototype.tick=function(a,b){if(this.type==Gizmo.TYPE.FIXED)this.destination==Gizmo.DEST.ROTATE?a.radian=a.dir:a.dir=null;else if(this.type==Gizmo.TYPE.OWN)this.destination==Gizmo.DEST.ROTATE_L?a.dir-=a.step:this.destination==Gizmo.DEST.ROTATE_R?a.dir+=a.step:this.destination==Gizmo.DEST.LEFT?a.dir=Math.PI:this.destination==Gizmo.DEST.RIGHT&&(a.dir=0);else{var c=b.x-a.x,d=b.y-a.y;Math.abs(c)<=a.speed&&(c=0);Math.abs(d)<=a.speed&&(d=0);this.type==Gizmo.TYPE.AIM?this.destination==Gizmo.DEST.TO_X?
a.radian=0>c?Math.PI:0:this.destination==Gizmo.DEST.TO_Y?a.radian=0>c?-Math.SQ:Math.SQ:this.destination==Gizmo.DEST.ROTATE&&(b=a.calcDistance(b),a.speed<b&&(a.radian=Math.close(a.radian,Math.atan2(d,c),this.param?this.param:Math.PI/30),a.radian=Math.trim(a.radian))):this.type==Gizmo.TYPE.CHASE&&(this.destination==Gizmo.DEST.TO?a.dir=Math.atan2(d,c):this.destination==Gizmo.DEST.TO_X&&c?a.dir=Math.atan2(0,c):this.destination==Gizmo.DEST.TO_Y&&d?a.dir=Math.atan2(d,0):this.destination==Gizmo.DEST.ROTATE&&
(a.dir=Math.close(a.dir,Math.atan2(d,c),this.param?this.param:Math.PI/60),a.radian=a.dir))}};function Movement(a){var b=parseInt(a);this.cond=a;this.count=b==a?b:null;this.list=[]}Movement.COND={X:"x",Y:"y"};Movement.prototype.add=function(a,b,c){this.list.push(new Gizmo(a,b,c));return this};
Movement.prototype.isValid=function(a,b){if(this.cond){if(this.count){if(a.routineCnt++<this.count)return!0;a.routineCnt=0;return!1}var c=b.x-a.x;b=b.y-a.y;return this.cond==Movement.COND.X&&Math.abs(c)<=a.speed||this.cond==Movement.COND.Y&&Math.abs(b)<=a.speed?!1:!0}};Movement.prototype.tick=function(a,b){this.list.forEach(function(c){c.tick(a,b)});this.isValid(a,b)||(a.routineIx++,a.routine.length<=a.routineIx&&(a.routineIx=0))};
var Region=function(a,b,c){b=void 0===b?Region.DefaultSize:b;c=void 0===c?Region.Type.CIRCLE:c;this.matter=a;this.size=b;this.type=c;this.width=2*b};Region.prototype.isHit=function(a){if(this.type==Region.Type.CIRCLE&&a.type==Region.Type.CIRCLE){var b=this.matter.x-a.matter.x,c=this.matter.y-a.matter.y;return Math.sqrt(b*b+c*c)<this.size+a.size}console.log("*Not implement*")};
Region.prototype.draw=function(a){a.save();a.strokeStyle="rgba(80, 255, 80, 0.6)";this.type==Region.Type.RECTANGLE?a.strokeRect(-this.size,-this.size,this.width,this.width):(a.beginPath(),a.arc(0,0,this.size,0,Math.PI2,!1),a.stroke());a.restore()};Region.DefaultSize=4;Region.Type={CIRCLE:1,RECTANGLE:2};var Ship=function(a,b){Actor.call(this,a,b);this.effectH=!1;this.anim=new Animator(this,"ship001.png",Animator.TYPE.H,2*Ship.PATTERNS+1,1);this.reset()};$jscomp.inherits(Ship,Actor);Ship.DEG_STEP=Actor.DEG_STEP;
Ship.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Ship.prototype.recalculation=function(){var a=Field.Instance;Actor.prototype.recalculation.call(this);a&&(this.right=a.width-2*this.width,this.bottom=a.height-this.hH)};Ship.prototype.reset=function(){this.speed=Ship.MIN_SPEED;this.triggered=!1;this.chamberList=[new Chamber(Shot,4,Ship.MAX_SHOTS)];this.chamberList.forEach(function(a){return a.reset()});this.missileLevel=0};
Ship.prototype.speedup=function(){this.speed*=1.25;Ship.MAX_SPEED<this.speed&&(this.speed=Ship.MAX_SPEED)};
Ship.prototype.powerUpMissile=function(){this.missileLevel++;1==this.missileLevel?this.chamberList.push(new Chamber(Missile,16,2,{gravity:.05,dir:0})):2==this.missileLevel?this.chamberList.push(new Chamber(Missile,16,2,{gravity:-.05,dir:0})):3==this.missileLevel&&(this.chamberList.push(new Chamber(Missile,16,2,{gravity:.05,dir:Math.PI})),this.chamberList.push(new Chamber(Missile,16,2,{gravity:-.05,dir:Math.PI})))};
Ship.prototype.inkey=function(a){var b=!1,c=0;if(a.ArrowLeft||a.Left||a.k37)c=1,b=!0;else if(a.ArrowRight||a.Right||a.k39)c=-1,b=!0;if(a.ArrowUp||a.Up||a.k38)c=2-.5*c,b=!0;else if(a.ArrowDown||a.Down||a.k40)c*=.5,b=!0;b&&(this.dir=(c+1)*Math.SQ);if(a.Control||a.Shift||a.k16||a.k17)this.triggered=!0};
Ship.prototype.move=function(){this.dir=null;this.aim(Controller.Instance.point);this.inkey(Controller.Instance.keys);Controller.Instance.touch&&(this.triggered=!0);var a=Actor.prototype.move.call(this);if(!this.isGone)if(this.walled)this.fate();else{if(this.x<this.hW||this.right<this.x)this.x=this.svX;if(this.y<this.hH||this.bottom<this.y)this.y=this.svY;return a}};Ship.MIN_SPEED=3;Ship.MAX_SPEED=5;Ship.MAX_SHOTS=7;Ship.PATTERNS=2;
var Shot=function(a,b){Actor.call(this,a,b);this.dir=-Math.PI/2;this.width=2;this.speed=8;this.size=2;this.maxX=Field.Instance.width;this.fillStyle="rgba(255, 255, 0, 0.7)";Field.Instance.calcPan(this.x)};$jscomp.inherits(Shot,Actor);Shot.DEG_STEP=Actor.DEG_STEP;Shot.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Shot.prototype.fate=function(){this.eject()};Shot.prototype.move=function(a){Actor.prototype.move.call(this,a);0>this.y&&this.eject();this.walled&&this.fate()};var AjaxUtils=function(){};
AjaxUtils.fetch=function(a,b,c){c=void 0===c?{}:c;return"function"===typeof fetch?fetch(a,{method:"post",headers:c,body:b,credentials:"include"}):new Promise(function(d,e){var f=new XMLHttpRequest;f.open("post",a);f.withCredentials=!0;f.responseType="blob";f.addEventListener("loadend",function(a){if(200<=f.status&&300>f.status){a=f.getResponseHeader("Content-Type");var b=new Blob([f.response],{type:a});d({blob:function(){return b}})}else e(f)});Object.keys(c).forEach(function(a){f.setRequestHeader(a,
c[a])});f.send(b)})};AjaxUtils.post=function(a,b,c){return AjaxUtils.fetch(a,b)};AjaxUtils.postJSON=function(a,b){var c={"Content-Type":"application/json"},d=document.querySelector('[name="_csrf_header"]');if(d){d=d.getAttribute("content");var e=document.querySelector('[name="_csrf"]').getAttribute("content");c[d]=e}return AjaxUtils.fetch(a,b,c)};
document.addEventListener("DOMContentLoaded",function(){var a=new AppMain,b=function(){var c=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;a.control();a.draw();c(b)};b()});var AppMain=function(){this.controller=new Controller;this.field=new Field(1024,768);new FlexibleView(1024,768);this.init()};AppMain.prototype.init=function(){var a=new Ship(496,668);this.field.actorList.push(a)};AppMain.prototype.control=function(){};
AppMain.prototype.draw=function(){this.field.draw()};
